{{ $folder := .Get "folder" }}
{{ $path := printf "static/%s" $folder }}
{{ $galleryID := printf "gallery-%s" (replace $folder "/" "-") }}

{{ if fileExists $path }}
  {{ $files := readDir $path }}
  {{ $images := slice }}
  
  <!-- Coletar apenas imagens -->
  {{ range $files }}
    {{ $ext := lower (path.Ext .Name) }}
    {{ if in (slice ".jpg" ".jpeg" ".png" ".gif" ".webp" ".bmp" ".tiff") $ext }}
      {{ $images = $images | append . }}
    {{ end }}
  {{ end }}

  <!-- Ordenar por tamanho (maiores primeiro) -->
  {{ $images = sort $images "Size" "desc" }}

  <div class="gallery-container">
    <div class="masonry-gallery" id="{{ $galleryID }}-container">
      {{ range $index, $image := $images }}
        <div class="gallery-item" onclick="openLightbox('{{ $galleryID }}', {{ $index }})">
          <img src="/{{ $folder }}/{{ $image.Name }}" 
               alt="{{ $image.Name }}" 
               loading="lazy"
               data-index="{{ $index }}">
        </div>
      {{ end }}
    </div>
  </div>

  <!-- Lightbox -->
  <div id="{{ $galleryID }}-lightbox" class="lightbox" onclick="closeLightbox('{{ $galleryID }}')">
    <span class="close-btn" onclick="closeLightbox('{{ $galleryID }}')">&times;</span>
    <span class="nav-btn prev-btn" onclick="changeImage('{{ $galleryID }}', -1)">&#10094;</span>
    <span class="nav-btn next-btn" onclick="changeImage('{{ $galleryID }}', 1)">&#10095;</span>
    
    <div class="lightbox-content">
      <img id="{{ $galleryID }}-lightbox-img" src="" alt="">
      <div class="image-counter">
        <span id="{{ $galleryID }}-current-index">1</span> / <span id="{{ $galleryID }}-total-images">{{ len $images }}</span>
      </div>
    </div>
  </div>

  <!-- Dados das imagens para o JavaScript -->
  <script>
    // Inicializar apenas se não existir
    if (typeof window.galleryData === 'undefined') {
      window.galleryData = {};
    }
    
    window.galleryData['{{ $galleryID }}'] = {
      images: [
        {{ range $images }}
          "/{{ $folder }}/{{ .Name }}",
        {{ end }}
      ],
      currentIndex: 0,
      touchStartX: 0,
      touchEndX: 0
    };

    function openLightbox(galleryId, index) {
      const gallery = window.galleryData[galleryId];
      gallery.currentIndex = index;
      
      document.getElementById(galleryId + '-lightbox-img').src = gallery.images[index];
      document.getElementById(galleryId + '-current-index').textContent = index + 1;
      document.getElementById(galleryId + '-lightbox').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Adicionar event listeners de touch
      setupTouchEvents(galleryId);
    }

    function closeLightbox(galleryId) {
      document.getElementById(galleryId + '-lightbox').style.display = 'none';
      document.body.style.overflow = 'auto';
      
      // Remover event listeners de touch
      removeTouchEvents(galleryId);
    }

    function changeImage(galleryId, direction) {
      event.stopPropagation();
      const gallery = window.galleryData[galleryId];
      
      gallery.currentIndex += direction;
      
      if (gallery.currentIndex >= gallery.images.length) {
        gallery.currentIndex = 0;
      } else if (gallery.currentIndex < 0) {
        gallery.currentIndex = gallery.images.length - 1;
      }
      
      document.getElementById(galleryId + '-lightbox-img').src = gallery.images[gallery.currentIndex];
      document.getElementById(galleryId + '-current-index').textContent = gallery.currentIndex + 1;
    }

    // Configurar eventos de touch para swipe
    function setupTouchEvents(galleryId) {
      const lightbox = document.getElementById(galleryId + '-lightbox');
      const lightboxImg = document.getElementById(galleryId + '-lightbox-img');
      const gallery = window.galleryData[galleryId];
      
      function handleTouchStart(e) {
        gallery.touchStartX = e.changedTouches[0].screenX;
        gallery.touchStartY = e.changedTouches[0].screenY;
      }
      
      function handleTouchEnd(e) {
        gallery.touchEndX = e.changedTouches[0].screenX;
        gallery.touchEndY = e.changedTouches[0].screenY;
        handleSwipe(galleryId);
      }
      
      function handleSwipe(currentGalleryId) {
        const diffX = gallery.touchStartX - gallery.touchEndX;
        const diffY = gallery.touchStartY - gallery.touchEndY;
        
        // Verificar se é um swipe horizontal (não vertical)
        if (Math.abs(diffX) > Math.abs(diffY)) {
          // Limiar mínimo para considerar como swipe
          if (Math.abs(diffX) > 50) {
            if (diffX > 0) {
              // Swipe para esquerda - próxima imagem
              changeImage(currentGalleryId, 1);
            } else {
              // Swipe para direita - imagem anterior
              changeImage(currentGalleryId, -1);
            }
          }
        }
      }
      
      // Armazenar as funções para poder remover depois
      gallery.touchStartHandler = handleTouchStart;
      gallery.touchEndHandler = handleTouchEnd;
      
      lightbox.addEventListener('touchstart', gallery.touchStartHandler, { passive: true });
      lightbox.addEventListener('touchend', gallery.touchEndHandler, { passive: true });
      lightboxImg.addEventListener('touchstart', gallery.touchStartHandler, { passive: true });
      lightboxImg.addEventListener('touchend', gallery.touchEndHandler, { passive: true });
    }

    function removeTouchEvents(galleryId) {
      const gallery = window.galleryData[galleryId];
      const lightbox = document.getElementById(galleryId + '-lightbox');
      const lightboxImg = document.getElementById(galleryId + '-lightbox-img');
      
      if (gallery.touchStartHandler) {
        lightbox.removeEventListener('touchstart', gallery.touchStartHandler);
        lightboxImg.removeEventListener('touchstart', gallery.touchStartHandler);
      }
      if (gallery.touchEndHandler) {
        lightbox.removeEventListener('touchend', gallery.touchEndHandler);
        lightboxImg.removeEventListener('touchend', gallery.touchEndHandler);
      }
    }

    // Navegação com teclado
    document.addEventListener('keydown', function(event) {
      // Encontrar qual lightbox está aberta
      const openLightboxes = document.querySelectorAll('.lightbox[style*="display: block"]');
      if (openLightboxes.length > 0) {
        const lightboxId = openLightboxes[0].id.replace('-lightbox', '');
        
        switch(event.key) {
          case 'Escape':
            closeLightbox(lightboxId);
            break;
          case 'ArrowLeft':
          case 'ArrowUp':
          case 'PageUp':
            changeImage(lightboxId, -1);
            event.preventDefault();
            break;
          case 'ArrowRight':
          case 'ArrowDown':
          case 'PageDown':
            changeImage(lightboxId, 1);
            event.preventDefault();
            break;
        }
      }
    });

    // Fechar ao clicar fora da imagem
    document.addEventListener('click', function(event) {
      const openLightboxes = document.querySelectorAll('.lightbox[style*="display: block"]');
      openLightboxes.forEach(lightbox => {
        const lightboxId = lightbox.id.replace('-lightbox', '');
        if (event.target === lightbox) {
          closeLightbox(lightboxId);
        }
      });
    });

    // Prevenir que cliques na imagem fechem o lightbox
    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('lightbox-content') || 
          event.target.id.includes('lightbox-img')) {
        event.stopPropagation();
      }
    });
  </script>

{{ else }}
  <div class="error">Diretório não encontrado: {{ $folder }}</div>
{{ end }}

<style>
/* Layout Masonry para fotos mistas */
.masonry-gallery {
  column-count: 3;
  column-gap: 1rem;
  margin: 2rem 0;
}

.gallery-item {
  break-inside: avoid;
  margin-bottom: 1rem;
  cursor: pointer;
  transition: transform 0.3s ease;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.gallery-item:hover {
  transform: scale(1.02);
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}

.gallery-item img {
  width: 100%;
  height: auto;
  display: block;
  transition: transform 0.3s ease;
}

/* Lightbox */
.lightbox {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(5px);
  touch-action: pan-y; /* Permitir scroll vertical quando necessário */
}

.lightbox-content {
  position: relative;
  margin: auto;
  padding: 20px;
  max-width: 90%;
  max-height: 90%;
  top: 50%;
  transform: translateY(-50%);
  text-align: center;
  touch-action: none; /* Desabilitar comportamentos de touch padrão na imagem */
}

.lightbox-content img {
  max-width: 100%;
  max-height: 80vh;
  object-fit: contain;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}

.close-btn {
  position: absolute;
  top: 20px;
  right: 35px;
  color: #fff;
  font-size: 40px;
  font-weight: bold;
  cursor: pointer;
  z-index: 1001;
  transition: color 0.3s ease;
  touch-action: manipulation;
}

.close-btn:hover {
  color: #ccc;
}

.nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  color: white;
  font-size: 30px;
  font-weight: bold;
  cursor: pointer;
  padding: 16px;
  background-color: rgba(0,0,0,0.3);
  border-radius: 50%;
  user-select: none;
  transition: background-color 0.3s ease;
  touch-action: manipulation;
}

.nav-btn:hover {
  background-color: rgba(0,0,0,0.7);
}

.prev-btn {
  left: 20px;
}

.next-btn {
  right: 20px;
}

.image-counter {
  color: white;
  font-size: 16px;
  margin-top: 15px;
  text-align: center;
  user-select: none;
}

/* Efeito de transição suave para troca de imagens */
.lightbox-content img {
  transition: opacity 0.3s ease;
}

.lightbox-content img.fading {
  opacity: 0.7;
}

/* Indicador de swipe para mobile */
.swipe-hint {
  position: absolute;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  color: rgba(255,255,255,0.7);
  font-size: 14px;
  text-align: center;
  display: none;
}

@media (max-width: 768px) {
  .swipe-hint {
    display: block;
  }
}

/* Responsividade */
@media (max-width: 1200px) {
  .masonry-gallery {
    column-count: 3;
  }
}

@media (max-width: 768px) {
  .masonry-gallery {
    column-count: 2;
  }
  
  .lightbox-content {
    max-width: 95%;
    padding: 10px;
  }
  
  .close-btn {
    top: 10px;
    right: 20px;
    font-size: 30px;
  }
  
  .nav-btn {
    font-size: 24px;
    padding: 12px;
  }
  
  /* Botões menores em mobile */
  .nav-btn {
    padding: 10px;
    font-size: 20px;
  }
}

@media (max-width: 480px) {
  .masonry-gallery {
    column-count: 1;
  }
  
  .nav-btn {
    padding: 8px;
    font-size: 18px;
  }
}

.error {
  color: #721c24;
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  padding: 1rem;
  border-radius: 4px;
  margin: 1rem 0;
}
</style>