{{ $folder := .Get "folder" }}
{{ $path := printf "static/%s" $folder }}
{{ $galleryID := printf "gallery-%s" (replace $folder "/" "-") }}

{{ if fileExists $path }}
  {{ $files := readDir $path }}
  {{ $images := slice }}
  
  <!-- Coletar apenas imagens -->
  {{ range $files }}
    {{ $ext := lower (path.Ext .Name) }}
    {{ if in (slice ".jpg" ".jpeg" ".png" ".gif" ".webp" ".bmp" ".tiff") $ext }}
      {{ $images = $images | append . }}
    {{ end }}
  {{ end }}

  <!-- Ordenar por tamanho (maiores primeiro) -->
  {{ $images = sort $images "Size" "desc" }}

  <div class="gallery-container">
    <div class="masonry-gallery" id="{{ $galleryID }}-container">
      {{ range $index, $image := $images }}
        <div class="gallery-item" onclick="openLightbox('{{ $galleryID }}', {{ $index }})">
          <img src="/{{ $folder }}/{{ $image.Name }}" 
               alt="{{ $image.Name }}" 
               loading="lazy"
               data-index="{{ $index }}">
        </div>
      {{ end }}
    </div>
  </div>

  <!-- Lightbox -->
  <div id="{{ $galleryID }}-lightbox" class="lightbox">
    <span class="close-btn" onclick="closeLightbox('{{ $galleryID }}')">&times;</span>
    <span class="nav-btn prev-btn" onclick="changeImage('{{ $galleryID }}', -1)">&#10094;</span>
    <span class="nav-btn next-btn" onclick="changeImage('{{ $galleryID }}', 1)">&#10095;</span>
    
    <div class="lightbox-content" onclick="handleLightboxClick('{{ $galleryID }}', event)">
      <img id="{{ $galleryID }}-lightbox-img" src="" alt="" 
           oncontextmenu="return false;"
           ondragstart="return false;"
           onclick="handleImageClick('{{ $galleryID }}', event)">
      <div class="image-counter">
        <span id="{{ $galleryID }}-current-index">1</span> / <span id="{{ $galleryID }}-total-images">{{ len $images }}</span>
      </div>
      <div class="zoom-hint" id="{{ $galleryID }}-zoom-hint">
        <span>üîç Clique para zoom</span>
      </div>
    </div>
  </div>

  <!-- Dados das imagens para o JavaScript -->
  <script>
    // Inicializar apenas se n√£o existir
    if (typeof window.galleryData === 'undefined') {
      window.galleryData = {};
    }
    
    window.galleryData['{{ $galleryID }}'] = {
      images: [
        {{ range $images }}
          "/{{ $folder }}/{{ .Name }}",
        {{ end }}
      ],
      currentIndex: 0,
      touchStartX: 0,
      touchEndX: 0,
      isZoomed: false,
      scale: 1,
      lastScale: 1,
      initialDistance: null
    };

    function openLightbox(galleryId, index) {
      const gallery = window.galleryData[galleryId];
      gallery.currentIndex = index;
      gallery.isZoomed = false;
      gallery.scale = 1;
      
      const lightboxImg = document.getElementById(galleryId + '-lightbox-img');
      lightboxImg.style.transform = 'scale(1)';
      lightboxImg.style.cursor = 'zoom-in';
      
      document.getElementById(galleryId + '-lightbox-img').src = gallery.images[index];
      document.getElementById(galleryId + '-current-index').textContent = index + 1;
      document.getElementById(galleryId + '-lightbox').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Adicionar event listeners
      setupTouchEvents(galleryId);
      setupZoomEvents(galleryId);
    }

    function closeLightbox(galleryId) {
      document.getElementById(galleryId + '-lightbox').style.display = 'none';
      document.body.style.overflow = 'auto';
      
      // Resetar zoom
      const gallery = window.galleryData[galleryId];
      gallery.isZoomed = false;
      gallery.scale = 1;
      
      // Remover event listeners
      removeTouchEvents(galleryId);
      removeZoomEvents(galleryId);
    }

    function handleLightboxClick(galleryId, event) {
      // S√≥ fecha o lightbox se clicar exatamente no background (n√£o na imagem ou conte√∫do)
      if (event.target === document.getElementById(galleryId + '-lightbox') || 
          event.target.classList.contains('lightbox-content')) {
        closeLightbox(galleryId);
      }
    }

    function handleImageClick(galleryId, event) {
      event.stopPropagation(); // Impede que o clique se propague para o lightbox
      toggleZoom(galleryId);
    }

    function changeImage(galleryId, direction) {
      event.stopPropagation();
      const gallery = window.galleryData[galleryId];
      
      // Resetar zoom ao mudar de imagem
      gallery.isZoomed = false;
      gallery.scale = 1;
      const lightboxImg = document.getElementById(galleryId + '-lightbox-img');
      lightboxImg.style.transform = 'scale(1)';
      lightboxImg.style.cursor = 'zoom-in';
      
      gallery.currentIndex += direction;
      
      if (gallery.currentIndex >= gallery.images.length) {
        gallery.currentIndex = 0;
      } else if (gallery.currentIndex < 0) {
        gallery.currentIndex = gallery.images.length - 1;
      }
      
      document.getElementById(galleryId + '-lightbox-img').src = gallery.images[gallery.currentIndex];
      document.getElementById(galleryId + '-current-index').textContent = gallery.currentIndex + 1;
    }

    // Fun√ß√µes de Zoom
    function toggleZoom(galleryId) {
      const gallery = window.galleryData[galleryId];
      const lightboxImg = document.getElementById(galleryId + '-lightbox-img');
      
      if (!gallery.isZoomed) {
        // Aplicar zoom
        gallery.scale = 2;
        lightboxImg.style.transform = `scale(${gallery.scale})`;
        lightboxImg.style.cursor = 'zoom-out';
        gallery.isZoomed = true;
      } else {
        // Remover zoom
        gallery.scale = 1;
        lightboxImg.style.transform = `scale(${gallery.scale})`;
        lightboxImg.style.cursor = 'zoom-in';
        gallery.isZoomed = false;
      }
    }

    function handlePinchZoom(galleryId, event) {
      const gallery = window.galleryData[galleryId];
      const lightboxImg = document.getElementById(galleryId + '-lightbox-img');
      
      if (event.touches.length === 2) {
        event.preventDefault();
        
        const touch1 = event.touches[0];
        const touch2 = event.touches[1];
        
        const currentDistance = Math.hypot(
          touch1.clientX - touch2.clientX,
          touch1.clientY - touch2.clientY
        );
        
        if (gallery.initialDistance === null) {
          gallery.initialDistance = currentDistance;
          gallery.lastScale = gallery.scale;
          return;
        }
        
        const scaleFactor = currentDistance / gallery.initialDistance;
        gallery.scale = Math.max(0.5, Math.min(3, gallery.lastScale * scaleFactor));
        
        lightboxImg.style.transform = `scale(${gallery.scale})`;
        lightboxImg.style.cursor = gallery.scale > 1 ? 'zoom-out' : 'zoom-in';
        gallery.isZoomed = gallery.scale > 1;
      }
    }

    function resetPinch(galleryId) {
      const gallery = window.galleryData[galleryId];
      gallery.initialDistance = null;
    }

    // Configurar eventos de zoom
    function setupZoomEvents(galleryId) {
      const lightboxImg = document.getElementById(galleryId + '-lightbox-img');
      const gallery = window.galleryData[galleryId];
      
      // Pinch para mobile
      function handleTouchMove(e) {
        handlePinchZoom(galleryId, e);
      }
      
      function handleTouchEnd() {
        resetPinch(galleryId);
      }
      
      // Clique √∫nico para mobile (touch)
      function handleTouchStart(e) {
        // S√≥ aplica zoom se for um toque √∫nico (n√£o pinch)
        if (e.touches.length === 1) {
          // Pequeno delay para distinguir entre clique e swipe
          setTimeout(() => {
            if (!gallery.isZoomed && e.touches.length === 0) {
              toggleZoom(galleryId);
            }
          }, 50);
        }
      }
      
      // Armazenar as fun√ß√µes
      gallery.touchMoveHandler = handleTouchMove;
      gallery.touchEndHandler = handleTouchEnd;
      gallery.touchStartHandler = handleTouchStart;
      
      // Adicionar event listeners
      lightboxImg.addEventListener('touchmove', gallery.touchMoveHandler, { passive: false });
      lightboxImg.addEventListener('touchend', gallery.touchEndHandler);
      lightboxImg.addEventListener('touchstart', gallery.touchStartHandler, { passive: true });
    }

    function removeZoomEvents(galleryId) {
      const gallery = window.galleryData[galleryId];
      const lightboxImg = document.getElementById(galleryId + '-lightbox-img');
      
      if (gallery.touchMoveHandler) {
        lightboxImg.removeEventListener('touchmove', gallery.touchMoveHandler);
      }
      if (gallery.touchEndHandler) {
        lightboxImg.removeEventListener('touchend', gallery.touchEndHandler);
      }
      if (gallery.touchStartHandler) {
        lightboxImg.removeEventListener('touchstart', gallery.touchStartHandler);
      }
    }

    // Configurar eventos de touch para swipe
    function setupTouchEvents(galleryId) {
      const lightbox = document.getElementById(galleryId + '-lightbox');
      const lightboxImg = document.getElementById(galleryId + '-lightbox-img');
      const gallery = window.galleryData[galleryId];
      
      function handleTouchStart(e) {
        // S√≥ processar swipe se n√£o estiver zoomado e com apenas 1 dedo
        if (!gallery.isZoomed && e.touches.length === 1) {
          gallery.touchStartX = e.changedTouches[0].screenX;
          gallery.touchStartY = e.changedTouches[0].screenY;
        }
      }
      
      function handleTouchEnd(e) {
        // S√≥ processar swipe se n√£o estiver zoomado e com apenas 1 dedo
        if (!gallery.isZoomed && e.touches.length === 0) {
          gallery.touchEndX = e.changedTouches[0].screenX;
          gallery.touchEndY = e.changedTouches[0].screenY;
          handleSwipe(galleryId);
        }
      }
      
      function handleSwipe(currentGalleryId) {
        const diffX = gallery.touchStartX - gallery.touchEndX;
        const diffY = gallery.touchStartY - gallery.touchEndY;
        
        // Verificar se √© um swipe horizontal (n√£o vertical)
        if (Math.abs(diffX) > Math.abs(diffY)) {
          // Limiar m√≠nimo para considerar como swipe
          if (Math.abs(diffX) > 50) {
            if (diffX > 0) {
              // Swipe para esquerda - pr√≥xima imagem
              changeImage(currentGalleryId, 1);
            } else {
              // Swipe para direita - imagem anterior
              changeImage(currentGalleryId, -1);
            }
          }
        }
      }
      
      // Armazenar as fun√ß√µes para poder remover depois
      gallery.swipeTouchStartHandler = handleTouchStart;
      gallery.swipeTouchEndHandler = handleTouchEnd;
      
      lightbox.addEventListener('touchstart', gallery.swipeTouchStartHandler, { passive: true });
      lightbox.addEventListener('touchend', gallery.swipeTouchEndHandler, { passive: true });
      lightboxImg.addEventListener('touchstart', gallery.swipeTouchStartHandler, { passive: true });
      lightboxImg.addEventListener('touchend', gallery.swipeTouchEndHandler, { passive: true });
    }

    function removeTouchEvents(galleryId) {
      const gallery = window.galleryData[galleryId];
      const lightbox = document.getElementById(galleryId + '-lightbox');
      const lightboxImg = document.getElementById(galleryId + '-lightbox-img');
      
      if (gallery.swipeTouchStartHandler) {
        lightbox.removeEventListener('touchstart', gallery.swipeTouchStartHandler);
        lightboxImg.removeEventListener('touchstart', gallery.swipeTouchStartHandler);
      }
      if (gallery.swipeTouchEndHandler) {
        lightbox.removeEventListener('touchend', gallery.swipeTouchEndHandler);
        lightboxImg.removeEventListener('touchend', gallery.swipeTouchEndHandler);
      }
    }

    // Navega√ß√£o com teclado
    document.addEventListener('keydown', function(event) {
      // Encontrar qual lightbox est√° aberta
      const openLightboxes = document.querySelectorAll('.lightbox[style*="display: block"]');
      if (openLightboxes.length > 0) {
        const lightboxId = openLightboxes[0].id.replace('-lightbox', '');
        
        switch(event.key) {
          case 'Escape':
            closeLightbox(lightboxId);
            break;
          case 'ArrowLeft':
          case 'ArrowUp':
          case 'PageUp':
            changeImage(lightboxId, -1);
            event.preventDefault();
            break;
          case 'ArrowRight':
          case 'ArrowDown':
          case 'PageDown':
            changeImage(lightboxId, 1);
            event.preventDefault();
            break;
          case ' ':
            // Espa√ßo para toggle zoom
            const gallery = window.galleryData[lightboxId];
            if (gallery) {
              toggleZoom(lightboxId);
            }
            event.preventDefault();
            break;
        }
      }
    });

    // Fechar apenas quando clicar no background do lightbox
    document.addEventListener('click', function(event) {
      const openLightboxes = document.querySelectorAll('.lightbox[style*="display: block"]');
      openLightboxes.forEach(lightbox => {
        const lightboxId = lightbox.id.replace('-lightbox', '');
        // S√≥ fecha se clicar diretamente no lightbox (background), n√£o nos elementos filhos
        if (event.target === lightbox) {
          closeLightbox(lightboxId);
        }
      });
    });
  </script>

{{ else }}
  <div class="error">Diret√≥rio n√£o encontrado: {{ $folder }}</div>
{{ end }}

<style>
/* Layout Masonry para fotos mistas */
.masonry-gallery {
  column-count: 3;
  column-gap: 1rem;
  margin: 2rem 0;
}

.gallery-item {
  break-inside: avoid;
  margin-bottom: 1rem;
  cursor: pointer;
  transition: transform 0.3s ease;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.gallery-item:hover {
  transform: scale(1.02);
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}

.gallery-item img {
  width: 100%;
  height: auto;
  display: block;
  transition: transform 0.3s ease;
}

/* Lightbox */
.lightbox {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(5px);
  touch-action: none;
}

.lightbox-content {
  position: relative;
  margin: auto;
  padding: 20px;
  max-width: 90%;
  max-height: 90%;
  top: 50%;
  transform: translateY(-50%);
  text-align: center;
  touch-action: none;
  cursor: default;
}

.lightbox-content img {
  max-width: 100%;
  max-height: 80vh;
  object-fit: contain;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
  cursor: zoom-in;
  transition: transform 0.3s ease;
  transform-origin: center center;
}

.lightbox-content img.zoomed {
  cursor: zoom-out;
}

.close-btn {
  position: absolute;
  top: 20px;
  right: 35px;
  color: #fff;
  font-size: 40px;
  font-weight: bold;
  cursor: pointer;
  z-index: 1001;
  transition: color 0.3s ease;
  touch-action: manipulation;
}

.close-btn:hover {
  color: #ccc;
}

.nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  color: white;
  font-size: 30px;
  font-weight: bold;
  cursor: pointer;
  padding: 16px;
  background-color: rgba(0,0,0,0.3);
  border-radius: 50%;
  user-select: none;
  transition: background-color 0.3s ease;
  touch-action: manipulation;
  z-index: 1001;
}

.nav-btn:hover {
  background-color: rgba(0,0,0,0.7);
}

.prev-btn {
  left: 20px;
}

.next-btn {
  right: 20px;
}

.image-counter {
  color: white;
  font-size: 16px;
  margin-top: 15px;
  text-align: center;
  user-select: none;
  z-index: 1001;
  position: relative;
}

.zoom-hint {
  color: rgba(255,255,255,0.7);
  font-size: 14px;
  margin-top: 10px;
  text-align: center;
  user-select: none;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 1001;
  position: relative;
}

.lightbox-content:hover .zoom-hint {
  opacity: 1;
}

/* Efeito de transi√ß√£o suave para troca de imagens */
.lightbox-content img {
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.lightbox-content img.fading {
  opacity: 0.7;
}

/* Responsividade */
@media (max-width: 1200px) {
  .masonry-gallery {
    column-count: 3;
  }
}

@media (max-width: 768px) {
  .masonry-gallery {
    column-count: 2;
  }
  
  .lightbox-content {
    max-width: 95%;
    padding: 10px;
  }
  
  .close-btn {
    top: 10px;
    right: 20px;
    font-size: 30px;
  }
  
  .nav-btn {
    font-size: 24px;
    padding: 12px;
  }
  
  .zoom-hint {
    display: none;
  }
}

@media (max-width: 480px) {
  .masonry-gallery {
    column-count: 1;
  }
  
  .nav-btn {
    padding: 8px;
    font-size: 18px;
  }
}

.error {
  color: #721c24;
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  padding: 1rem;
  border-radius: 4px;
  margin: 1rem 0;
}
</style>