{{ $folder := .Get "folder" }}
{{ $path := printf "static/%s" $folder }}
{{ $galleryID := printf "gallery-%s" (replace $folder "/" "-") }}

{{ if fileExists $path }}
  {{ $files := readDir $path }}
  {{ $images := slice }}
  
  <!-- Coletar apenas imagens -->
  {{ range $files }}
    {{ $ext := lower (path.Ext .Name) }}
    {{ if in (slice ".jpg" ".jpeg" ".png" ".gif" ".webp" ".bmp" ".tiff") $ext }}
      {{ $images = $images | append . }}
    {{ end }}
  {{ end }}

  <!-- Ordenar por tamanho (maiores primeiro) -->
  {{ $images = sort $images "Size" "desc" }}

  <div class="gallery-container">
    <div class="masonry-gallery" id="{{ $galleryID }}-container">
      {{ range $index, $image := $images }}
        <div class="gallery-item" onclick="openLightbox('{{ $galleryID }}', {{ $index }})">
          <img src="/{{ $folder }}/{{ $image.Name }}" 
               alt="{{ $image.Name }}" 
               loading="lazy"
               data-index="{{ $index }}">
        </div>
      {{ end }}
    </div>
  </div>

  <!-- Lightbox -->
  <div id="{{ $galleryID }}-lightbox" class="lightbox" onclick="closeLightbox('{{ $galleryID }}')">
    <span class="close-btn" onclick="closeLightbox('{{ $galleryID }}')">&times;</span>
    <span class="nav-btn prev-btn" onclick="changeImage('{{ $galleryID }}', -1)">&#10094;</span>
    <span class="nav-btn next-btn" onclick="changeImage('{{ $galleryID }}', 1)">&#10095;</span>
    
    <div class="lightbox-content">
      <img id="{{ $galleryID }}-lightbox-img" src="" alt="">
      <div class="image-counter">
        <span id="{{ $galleryID }}-current-index">1</span> / <span id="{{ $galleryID }}-total-images">{{ len $images }}</span>
      </div>
    </div>
  </div>

  <!-- Dados das imagens para o JavaScript -->
  <script>
    // Inicializar apenas se não existir
    if (typeof window.galleryData === 'undefined') {
      window.galleryData = {};
    }
    
    window.galleryData['{{ $galleryID }}'] = {
      images: [
        {{ range $images }}
          "/{{ $folder }}/{{ .Name }}",
        {{ end }}
      ],
      currentIndex: 0
    };

    function openLightbox(galleryId, index) {
      const gallery = window.galleryData[galleryId];
      gallery.currentIndex = index;
      
      document.getElementById(galleryId + '-lightbox-img').src = gallery.images[index];
      document.getElementById(galleryId + '-current-index').textContent = index + 1;
      document.getElementById(galleryId + '-lightbox').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox(galleryId) {
      document.getElementById(galleryId + '-lightbox').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function changeImage(galleryId, direction) {
      event.stopPropagation();
      const gallery = window.galleryData[galleryId];
      
      gallery.currentIndex += direction;
      
      if (gallery.currentIndex >= gallery.images.length) {
        gallery.currentIndex = 0;
      } else if (gallery.currentIndex < 0) {
        gallery.currentIndex = gallery.images.length - 1;
      }
      
      document.getElementById(galleryId + '-lightbox-img').src = gallery.images[gallery.currentIndex];
      document.getElementById(galleryId + '-current-index').textContent = gallery.currentIndex + 1;
    }

    // Navegação com teclado (global, mas fecha qualquer lightbox aberta)
    document.addEventListener('keydown', function(event) {
      // Encontrar qual lightbox está aberta
      const openLightboxes = document.querySelectorAll('.lightbox[style*="display: block"]');
      if (openLightboxes.length > 0) {
        const lightboxId = openLightboxes[0].id.replace('-lightbox', '');
        
        if (event.key === 'Escape') closeLightbox(lightboxId);
        if (event.key === 'ArrowLeft') changeImage(lightboxId, -1);
        if (event.key === 'ArrowRight') changeImage(lightboxId, 1);
      }
    });

    // Fechar ao clicar fora da imagem (configurado individualmente no HTML)
  </script>

{{ else }}
  <div class="error">Diretório não encontrado: {{ $folder }}</div>
{{ end }}

<style>
/* Layout Masonry para fotos mistas */
.masonry-gallery {
  column-count: 3;
  column-gap: 1rem;
  margin: 2rem 0;
}

.gallery-item {
  break-inside: avoid;
  margin-bottom: 1rem;
  cursor: pointer;
  transition: transform 0.3s ease;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.gallery-item:hover {
  transform: scale(1.02);
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}

.gallery-item img {
  width: 100%;
  height: auto;
  display: block;
  transition: transform 0.3s ease;
}

/* Lightbox */
.lightbox {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(5px);
}

.lightbox-content {
  position: relative;
  margin: auto;
  padding: 20px;
  max-width: 90%;
  max-height: 90%;
  top: 50%;
  transform: translateY(-50%);
  text-align: center;
}

.lightbox-content img {
  max-width: 100%;
  max-height: 80vh;
  object-fit: contain;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.close-btn {
  position: absolute;
  top: 20px;
  right: 35px;
  color: #fff;
  font-size: 40px;
  font-weight: bold;
  cursor: pointer;
  z-index: 1001;
  transition: color 0.3s ease;
}

.close-btn:hover {
  color: #ccc;
}

.nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  color: white;
  font-size: 30px;
  font-weight: bold;
  cursor: pointer;
  padding: 16px;
  background-color: rgba(0,0,0,0.3);
  border-radius: 50%;
  user-select: none;
  transition: background-color 0.3s ease;
}

.nav-btn:hover {
  background-color: rgba(0,0,0,0.7);
}

.prev-btn {
  left: 20px;
}

.next-btn {
  right: 20px;
}

.image-counter {
  color: white;
  font-size: 16px;
  margin-top: 15px;
  text-align: center;
}

/* Responsividade */
@media (max-width: 1200px) {
  .masonry-gallery {
    column-count: 3;
  }
}

@media (max-width: 768px) {
  .masonry-gallery {
    column-count: 2;
  }
  
  .lightbox-content {
    max-width: 95%;
    padding: 10px;
  }
  
  .close-btn {
    top: 10px;
    right: 20px;
    font-size: 30px;
  }
  
  .nav-btn {
    font-size: 24px;
    padding: 12px;
  }
}

@media (max-width: 480px) {
  .masonry-gallery {
    column-count: 1;
  }
}

.error {
  color: #721c24;
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  padding: 1rem;
  border-radius: 4px;
  margin: 1rem 0;
}
</style>